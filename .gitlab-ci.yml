
stages:          # List of stages for jobs, and their order of execution
  - build
  - test
  - deploy

build-dotnet-code:       # Build worker code.
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:7.0
  variables:
    NUGET_PACKAGES: "/builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/worker/.nuget/packages"   # Change nuget packages path 
  cache:
    key: ${CI_COMMIT_REF_SLUG}            # Isolated cache for each branch
    paths:
      - worker/.nuget/packages/**         # Save restored packages (Nuget)
  script:
    - echo "Compiling the code..."
    - cd worker
    - dotnet restore
    - dotnet publish -c Release -o publish --self-contained false
    - echo "Compile complete."
  artifacts:
    paths:
      - worker/publish/
  only:
    - Development
    - main
    - tags

test-dontnet-code:   # Test worker code.
  stage: test        # It only starts when the job in the build stage completes successfully.
  image: mcr.microsoft.com/dotnet/sdk:7.0
  script:
    - echo "Running unit tests... This will take about 60 seconds."
    - cd worker
    - mkdir -p TestResults    # Create TestResults folder if it doensn't exist 
    - dotnet test  --logger "trx;LogFileName=TestResults/Dotnet-TestResults_$(date +%s).trx"      # Test the code and save the testing results.
    - pwd
    - ls -R /TestResults
  artifacts:
    paths:
      - worker/TestResults/*.trx
    expire_in: 1 week
  only:
    - prepare
    - Development
    - main
    - tags

lint-test-job:   # This job also runs in the test stage.
  stage: test    # It can run at the same time as unit-test-job (in parallel).
  script:
    - echo "Linting code... This will take about 10 seconds."
    - sleep 10
    - echo "No lint issues found."
  only:
    - Development
    - main
    - tags

deploy-job:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  environment: production
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
  only:
    - Development
    - main
    - tags
